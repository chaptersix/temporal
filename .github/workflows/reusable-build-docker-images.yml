name: Reusable - Build Docker Images

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        type: string
        required: true
      image-tag:
        description: 'Docker image tag'
        type: string
        required: true
      image-repo:
        description: 'Docker image repository (e.g., temporalio, temporaliotest)'
        type: string
        required: false
        default: 'temporaliotest'
      upload-artifact:
        description: 'Upload Docker image as artifact'
        type: boolean
        required: false
        default: false
      push-to-registry:
        description: 'Push images to Docker Hub'
        type: boolean
        required: false
        default: false
      tag-latest:
        description: 'Tag images as latest'
        type: boolean
        required: false
        default: false
    secrets:
      dockerhub-username:
        description: 'Docker Hub username'
        required: false
      dockerhub-token:
        description: 'Docker Hub token'
        required: false

jobs:
  build-docker-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Validate image tag
        env:
          IMAGE_TAG: ${{ inputs.image-tag }}
        run: |
          # Validate image tag format (Docker tag rules)
          if ! echo "$IMAGE_TAG" | grep -qE '^[a-zA-Z0-9][a-zA-Z0-9._-]{0,127}$'; then
            echo "Error: Invalid Docker image tag format"
            echo "Tag must start with alphanumeric, contain only [a-zA-Z0-9._-], and be max 128 chars"
            echo "Provided tag: $IMAGE_TAG"
            exit 1
          fi

          # Prevent shell metacharacters
          if echo "$IMAGE_TAG" | grep -qE '[;|&$`()]'; then
            echo "Error: Image tag contains shell metacharacters"
            exit 1
          fi

          echo "✓ Image tag validation passed: $IMAGE_TAG"

      - name: Download amd64 binaries
        uses: actions/download-artifact@v4
        with:
          name: temporal-binaries-amd64
          path: build-artifacts/amd64

      - name: Download arm64 binaries
        uses: actions/download-artifact@v4
        with:
          name: temporal-binaries-arm64
          path: build-artifacts/arm64

      - name: Verify artifact checksums
        run: |
          echo "Verifying artifact integrity..."

          # Verify amd64 checksums
          if [ -f build-artifacts/amd64/checksums.txt ]; then
            cd build-artifacts/amd64
            if sha256sum -c --ignore-missing checksums.txt; then
              echo "✓ amd64 checksums verified"
            else
              echo "Error: amd64 checksum verification failed"
              exit 1
            fi
            cd ../..
          else
            echo "Warning: No checksums found for amd64 artifacts"
          fi

          # Verify arm64 checksums
          if [ -f build-artifacts/arm64/checksums.txt ]; then
            cd build-artifacts/arm64
            if sha256sum -c --ignore-missing checksums.txt; then
              echo "✓ arm64 checksums verified"
            else
              echo "Error: arm64 checksum verification failed"
              exit 1
            fi
            cd ../..
          else
            echo "Warning: No checksums found for arm64 artifacts"
          fi

      - name: Organize binaries
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/organize-docker-build-binaries.js');
            await script({ require });

      - name: Download Temporal CLI
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/download-temporal-cli.js');
            await script({ require });

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Docker Hub credentials
        if: inputs.push-to-registry
        run: |
          if [ -z "${{ secrets.dockerhub-username }}" ] || [ -z "${{ secrets.dockerhub-token }}" ]; then
            echo "Error: Docker Hub credentials are not configured"
            echo "Please set DOCKERHUB_USERNAME and DOCKERHUB_TOKEN secrets"
            exit 1
          fi
          echo "✓ Docker Hub credentials are configured"

      - name: Log in to Docker Hub
        if: inputs.push-to-registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.dockerhub-username }}
          password: ${{ secrets.dockerhub-token }}

      - name: Build Docker images
        env:
          IMAGE_REPO: ${{ inputs.image-repo }}
          IMAGE_SHA_TAG: ${{ inputs.image-tag }}
          IMAGE_BRANCH_TAG: ${{ inputs.image-tag }}
          TEMPORAL_SHA: ${{ github.sha }}
          TAG_LATEST: ${{ inputs.tag-latest }}
        run: |
          # Use branch-specific cache to prevent cross-contamination
          CACHE_SCOPE="docker-${{ github.workflow }}-${{ github.ref }}"
          docker buildx bake \
            --set "*.cache-from=type=gha,scope=$CACHE_SCOPE" \
            --set "*.cache-to=type=gha,mode=max,scope=$CACHE_SCOPE" \
            ${{ inputs.push-to-registry && '--push' || '--load' }} \
            -f .github/docker/docker-bake.hcl \
            server admin-tools

      - name: Save Docker image as artifact
        if: inputs.upload-artifact
        run: |
          docker save ${{ inputs.image-repo }}/server:${{ inputs.image-tag }} -o /tmp/temporal-server.tar
          echo ${{ inputs.image-tag }} > /tmp/image_tag

      - name: Upload Docker artifact
        if: inputs.upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: temporal-server-docker
          path: |
            /tmp/temporal-server.tar
            /tmp/image_tag
          retention-days: 7
