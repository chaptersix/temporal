name: Reusable - Build Binaries

on:
  workflow_call:
    inputs:
      snapshot:
        description: 'Use snapshot mode (true) or release mode (false)'
        type: boolean
        required: false
        default: true
      ref:
        description: 'Git ref to checkout'
        type: string
        required: true
      upload-artifacts:
        description: 'Upload binary artifacts'
        type: boolean
        required: false
        default: true

jobs:
  build-binaries:
    runs-on: ubuntu-latest
    # Using write permissions for both snapshot and release modes
    # Snapshot builds use --skip=publish so they won't actually publish
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release ${{ inputs.snapshot && '--snapshot' || '' }} --clean ${{ inputs.snapshot && '--skip=publish,announce' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Organize binaries for Docker
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/organize-binaries-for-docker.js');
            await script({ require });

      - name: Generate checksums for artifacts
        if: inputs.upload-artifacts
        run: |
          # Generate checksums for amd64 binaries
          cd build/amd64
          sha256sum ./* > checksums.txt
          echo "Generated checksums for amd64:"
          cat checksums.txt
          cd ../..

          # Generate checksums for arm64 binaries
          cd build/arm64
          sha256sum ./* > checksums.txt
          echo "Generated checksums for arm64:"
          cat checksums.txt
          cd ../..

      - name: Upload amd64 binaries artifact
        if: inputs.upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: temporal-binaries-amd64
          path: |
            build/amd64/*
            build/temporal/schema/**/*
          retention-days: 7

      - name: Upload arm64 binaries artifact
        if: inputs.upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: temporal-binaries-arm64
          path: |
            build/arm64/*
            build/temporal/schema/**/*
          retention-days: 7
