name: Reusable - Build Binaries

on:
  workflow_call:
    inputs:
      snapshot:
        description: 'Use snapshot mode (true) or release mode (false)'
        type: boolean
        required: false
        default: true
      ref:
        description: 'Git ref to checkout'
        type: string
        required: true
      upload-artifacts:
        description: 'Upload binary artifacts'
        type: boolean
        required: false
        default: true

jobs:
  build-binaries:
    runs-on: ubuntu-latest
    # Conditional permissions: only need write access for release mode
    # Snapshot builds don't publish to GitHub Releases, so read-only is sufficient
    permissions:
      contents: ${{ inputs.snapshot && 'read' || 'write' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release ${{ inputs.snapshot && '--snapshot' || '' }} --clean ${{ inputs.snapshot && '--skip=publish,announce' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Organize binaries for Docker
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Helper function to validate paths and prevent traversal
            const validatePath = (filePath, allowedPrefix) => {
              const normalized = path.normalize(filePath);
              const resolved = path.resolve(normalized);
              const allowedResolved = path.resolve(allowedPrefix);

              // Check for path traversal
              if (normalized.includes('..')) {
                throw new Error(`Path traversal detected in: ${filePath}`);
              }

              // Ensure path is within allowed directory
              if (!resolved.startsWith(allowedResolved)) {
                throw new Error(`Path outside allowed directory: ${filePath}`);
              }

              return normalized;
            };

            // Create build directories
            const archs = ['amd64', 'arm64'];
            const binaries = [
              'temporal-server',
              'temporal-cassandra-tool',
              'temporal-sql-tool',
              'temporal-elasticsearch-tool',
              'tdbg'
            ];

            // Validate architecture and binary names
            archs.forEach(arch => {
              if (!/^[a-z0-9]+$/.test(arch)) {
                throw new Error(`Invalid architecture name: ${arch}`);
              }
            });

            binaries.forEach(binary => {
              if (!/^[a-z0-9-]+$/.test(binary)) {
                throw new Error(`Invalid binary name: ${binary}`);
              }
            });

            archs.forEach(arch => {
              const dir = `build/${arch}`;
              validatePath(dir, 'build');
              if (!fs.existsSync(dir)) {
                fs.mkdirSync(dir, { recursive: true });
              }
            });

            // Map GoReleaser dist structure to build structure
            const archMap = {
              'amd64': 'amd64_v1',
              'arm64': 'arm64'
            };

            binaries.forEach(binary => {
              archs.forEach(arch => {
                const distArch = archMap[arch] || arch;
                const distPath = `dist/${binary}_linux_${distArch}/${binary}`;
                const buildPath = `build/${arch}/${binary}`;

                // Validate paths before file operations
                try {
                  validatePath(distPath, 'dist');
                  validatePath(buildPath, 'build');
                } catch (error) {
                  console.error(`Path validation failed: ${error.message}`);
                  throw error;
                }

                if (fs.existsSync(distPath)) {
                  fs.copyFileSync(distPath, buildPath);
                  console.log(`Copied ${distPath} -> ${buildPath}`);
                } else {
                  console.warn(`Binary not found: ${binary} for ${arch}`);
                }
              });
            });

            // Copy schema directory for admin-tools
            const schemaDir = 'build/temporal/schema';
            validatePath(schemaDir, 'build');
            if (!fs.existsSync(schemaDir)) {
              fs.mkdirSync(schemaDir, { recursive: true });
            }

            // Copy all schema files recursively with path validation
            const copyRecursive = (src, dest) => {
              // Validate both source and destination
              validatePath(src, 'schema');
              validatePath(dest, 'build');

              if (fs.statSync(src).isDirectory()) {
                if (!fs.existsSync(dest)) {
                  fs.mkdirSync(dest, { recursive: true });
                }
                fs.readdirSync(src).forEach(item => {
                  // Validate item name to prevent directory traversal
                  if (item.includes('..') || item.includes('/') || item.includes('\\')) {
                    throw new Error(`Invalid file name: ${item}`);
                  }
                  copyRecursive(path.join(src, item), path.join(dest, item));
                });
              } else {
                fs.copyFileSync(src, dest);
              }
            };

            if (fs.existsSync('schema')) {
              copyRecursive('schema', schemaDir);
              console.log('Copied schema directory');
            }

      - name: Generate checksums for artifacts
        if: inputs.upload-artifacts
        run: |
          # Generate checksums for amd64 binaries
          cd build/amd64
          sha256sum * > checksums.txt
          echo "Generated checksums for amd64:"
          cat checksums.txt
          cd ../..

          # Generate checksums for arm64 binaries
          cd build/arm64
          sha256sum * > checksums.txt
          echo "Generated checksums for arm64:"
          cat checksums.txt
          cd ../..

      - name: Upload amd64 binaries artifact
        if: inputs.upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: temporal-binaries-amd64
          path: |
            build/amd64/*
            build/temporal/schema/**/*
          retention-days: 7

      - name: Upload arm64 binaries artifact
        if: inputs.upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: temporal-binaries-arm64
          path: |
            build/arm64/*
            build/temporal/schema/**/*
          retention-days: 7
